<script src="https://cdn.jsdelivr.net/npm/bootstrap@5.0.2/dist/js/bootstrap.bundle.min.js"
    integrity="sha384-MrcW6ZMFYlzcLA8Nl+NtUVF0sA7MsXsP1UyJoMp4YLEuNSfAP+JcXn/tWtIaxVXM"
    crossorigin="anonymous"></script>
<style>
    .text-font {
        font-family: futura-pt, Tahoma, Geneva, Verdana, Arial, sans-serif;
        font-weight: 700;
        letter-spacing: .156rem;
        font-size: 1.125rem;
    }

    .text-price {
        padding: 0 .625rem;
        font-family: futura-pt, Tahoma, Geneva, Verdana, Arial, sans-serif;
        font-style: normal;
        font-size: .75rem;
        font-weight: 700;
        line-height: .813rem;
        letter-spacing: 1.6px;
    }

    .text-descriptions {
        font-family: futura-pt, Tahoma, Geneva, Verdana, Arial, sans-serif;
        font-style: normal;
        font-size: .75rem;
        font-weight: 400;
        line-height: 1.125rem;
        margin: .313rem 0 .938rem;
        padding: 0 .625rem;
    }

    .button-color {
        color: #4e4e4e;
        border-color: #4e4e4e;
    }

    .button-order {
        font-family: futura-pt, Tahoma, Geneva, Verdana, Arial, sans-serif;
        font-style: normal;
        font-size: .75rem;
        font-weight: 700;
        background-color: hsl(90, 40%, 50%);
        color: white;
    }
</style>



<link href="https://cdn.jsdelivr.net/npm/bootstrap@5.0.2/dist/css/bootstrap.min.css" rel="stylesheet"
    integrity="sha384-EVSTQN3/azprG1Anm3QDgpJLIm9Nao0Yz1ztcQTwFspd3yD65VohhpuuCOmLASjC" crossorigin="anonymous">

<div class="container my-5 py-5">

    <!--Section: Design Block-->
    <section>

        <div class="row">
            <div class="col-md-8">

                <div class="card mb-4 accordion" id="accordionExample">
                    <div class="card body accordion-item">
                        <h2 class="accordion-header" id="headingOne">
                            <div class="accordion-button collapsed text-uppercase text-font h4" type="button"
                                data-bs-toggle="collapse" data-bs-target="#collapseOne" data-mdb-toggle="collapse"
                                data-mdb-target="#collapseOne" aria-expanded="false" aria-controls="collapseOne">
                                Payment Methods
                            </div>
                        </h2>
                        <div id="collapseOne" class="accordion-collapse collapse" aria-labelledby="headingOne"
                            data-mdb-parent="#accordionExample" data-bs-parent="#accordionExample">
                            <div class="accordion-body">
                                <div class="form-outline d-flex justify-content-between">
                                    <div class="d-flex">
                                        <div>
                                            <p>Pay on Delivery</p>
                                        </div>
                                    </div>
                                    <div>
                                        <input type="radio" name="payment" value="COD">
                                    </div>
                                </div>
                            </div>

                            <div class="accordion-body">
                                <div class="form-outline d-flex justify-content-between">
                                    <div class="d-flex">
                                        <div>
                                            <p>Pay Online
                                            </p>
                                        </div>
                                    </div>
                                    <div>
                                        <input type="radio" name="payment" value="online">
                                    </div>
                                </div>
                            </div>
                        </div>
                    </div>
                </div>

                <div class="card mb-4" id="addressContainer">
                    <div class="card-body">
                        <p class="text-uppercase fw-bold mb-3 text-font">Delivery address</p>
                        <div class="row">
                            {{#each address}}
                            <div class="col-md-4 ">
                                <h4> {{this.addressDetails.addressName}} </h4>
                                <p> {{this.addressDetails.address}} ,  <br> <span>  {{this.addressDetails.pincode}}  <br> </span>
                                    <span>  {{this.addressDetails.phone}}  </span>
                                </p>
                            </div>
                            <div class="col-md-7 d-flex justify-content-end">

                                <input type="radio" id="addressRadio" value="{{this.addressDetails._id}}" name="addressDetail">

                            </div>
                            {{/each}}
                            <div class="col-md-7">
                                <button type="button" class="btn btn-outline-dark float-end button-color "
                                    data-bs-ripple-color="dark"
                                    class="accordion-button collapsed text-uppercase text-font h4" type="button"
                                    data-bs-toggle="collapse" data-bs-target="#collapseTwo" data-mdb-toggle="collapse"
                                    data-mdb-target="#collapseTwo" aria-expanded="false" aria-controls="collapseTwo">
                                    Add new Address
                                </button>
                            </div>

                            <div id="collapseTwo" class="accordion-collapse collapse" aria-labelledby="headingOne"
                                data-mdb-parent="#accordionExample" data-bs-parent="#accordionExample">
                                <div class="accordion-body">
                                    <div class="col-md-8 mb-4">
                                        <div class="card mb-4">
                                            <div class="card-header py-3">
                                                <h5 class="mb-0 text-font text-uppercase">Delivery address</h5>
                                            </div>
                                            <div class="card-body">
                                                <form id="addressForm">

                                                    <div class="row mb-4">
                                                        <div class="col">
                                                            <div class="form-outline">
                                                                <input type="text" name="addressName"
                                                                    id="form11Example1" class="form-control" />
                                                                <label class="form-label" for="form11Example1">Address
                                                                    name</label>
                                                            </div>
                                                        </div>

                                                    </div>
                                                    <!-- Text input -->
                                                    <div class="form-outline mb-4">
                                                        <input type="text" id="address" name="address"
                                                            class="form-control" required/>
                                                        <label class="form-label" for="form11Example4">Address</label>
                                                    </div>
                                                    <!-- pincode-->
                                                    <div class="form-outline mb-4">
                                                        <input type="text" id="pincode" name="pincode"
                                                            class="form-control"  required/>
                                                        <label class="form-label" for="form11Example3">Pincode</label>
                                                    </div>

                                                    <!-- Email input -->
                                                    <div class="form-outline mb-4">
                                                        <input type="email" id="email" name="email"
                                                            class="form-control" required />
                                                        <label class="form-label" for="form11Example5">Email</label>
                                                    </div>

                                                    <!-- Number input -->
                                                    <div class="form-outline mb-4">
                                                        <input type="number" id="mobile" name="phone"
                                                            class="form-control" required />
                                                        <label class="form-label" for="form11Example6">Phone</label>
                                                    </div>

                                                    <div class="text-center">
                                                        <button type="submit" id="add"
                                                            class="btn button-order col-md-10 btn-danger">Add new
                                                            Address </button>
                                                    </div>

                                                </form>
                                            </div>

                                        </div>
                                    </div>

                                </div>

                            </div>
                        </div>
                    </div>
                </div>
            </div>
            <div class="col-md-4 mb-4 position-static">
                <div class="card mb-4">
                    <div class="card-header py-3">
                        <h5 class="mb-0 text-font"> Items </h5>
                    </div>
                    <hr class="my-4">
                    <div class="card-body">
                        {{#each product }}
                        <div class="row">
                            <div class="col-md-4">
                                <img src="upload/{{this.product.image}}"
                                    class="rounded-3" style="width: 100px;" alt="food" />
                            </div>
                            <div class="col-md-6 ms-3">
                                <span class="mb-0 text-price">${{this.product.price}}</span>
                                <p class="mb-0 text-descriptions">{{this.product.name}} </p>
                                <p class="text-descriptions mt-0">Qty:<span class="text-descriptions fw-bold">{{this.count}}</span>
                                </p>
                            </div>
                        </div>
                        <hr class="my-4">
                        {{/each}}
                        <div class="card-footer mt-4">
                            <ul class="list-group list-group-flush">
                                <li
                                    class="list-group-item d-flex justify-content-between align-items-center border-0 px-0 pb-0 text-muted">
                                    Subtotal
                                    <span> ${{priceDetails.totalPrice}}</span>
                                </li>
                                <li
                                    class="list-group-item d-flex justify-content-between align-items-center border-0 px-0 pb-0 text-muted">
                                    Discount
                                    <span>${{priceDetails.discount}} </span>
                                </li>
                                <li
                                    class="list-group-item d-flex justify-content-between align-items-center px-0 fw-bold text-uppercase">
                                    Total to pay
                                    <span>${{priceDetails.total}}</span>
                                </li>
                            </ul>
                        </div>
                    </div>
                </div>
            </div>
            <div class="text-center">
                <button id="payment" type="button" class="btn button-order col-md-10 btn-primary"> Proceed to Pay
                </button>
            </div>
    </section>
    <!--Section: Design Block-->
</div>
<script src="https://code.jquery.com/jquery-3.6.0.js" integrity="sha256-H+K7U5CnXl1h5ywQfKtSj8PCmoN9aaq30gDh27Xc0jk="
    crossorigin="anonymous"></script>

<script src="https://cdn.jsdelivr.net/npm/bootstrap@5.0.2/dist/js/bootstrap.bundle.min.js"
    integrity="sha384-MrcW6ZMFYlzcLA8Nl+NtUVF0sA7MsXsP1UyJoMp4YLEuNSfAP+JcXn/tWtIaxVXM"
    crossorigin="anonymous"></script>
<script src="https://checkout.razorpay.com/v1/checkout.js"></script>
<script>
    $("#payment").click((event) => {
        event.preventDefault()
        $.ajax({
            url: '/place-order',
            method: 'post',
            data: {
                userId: "{{userId}}",
                method: $('input[name="payment"]:checked').val(),
                addressId: $("#addressRadio").val()
            },
            success: (response) => {
                alert(response)
                if (response.cod) {
                    location.href = '/order-successful'
                } else {
                    razorPay(response)
                }
            }
        })
    })
    function razorPay(order) {
        var options = {
            "key": "rzp_test_fwHvgkkniBblF9",
            "amount": order.amount * 10000,
            "currency": "INR",
            "name": "Anoona",
            "description": "Pay & Checkout this Course, Upgrade your DSA Skill",
            "image": "https://media.geeksforgeeks.org/wp-content/uploads/20210806114908/dummy-200x200.png",
            "order_id": order.id,
            "handler": function (response) {
                console.log(response)
                alert("This step of Payment Succeeded");
                verifyPayment(response, order)

            },
            "prefill": {
                //Here we are prefilling random contact
                "contact": "9876543210",
                //name and email id, so while checkout
                "name": "Twinkle Sharma",
                "email": "smtwinkle@gmail.com"
            },
            "notes": {
                "description": "Best Course for SDE placements",
                "language": "Available in 4 major Languages JAVA, C/ C++, Python, Javascript",
                "access": "This course have Lifetime Access"
            },
            "theme": {
                "color": "#2300a3"
            }
        };
        var razorpayObject = new Razorpay(options);
        razorpayObject.on('payment.failed', function (response) {
            console.log(response);
            alert("This step of Payment Failed");
        });
        razorpayObject.open()
    }
    function verifyPayment(response, order) {
        $.ajax({
            url: '/verify-payment',
            data: {
                response,
                order
            },
            method: 'post',
            success: (response) => {
                if (response.verify) {
                    location.href = '/order-successful'
                } else {
                    alert('Payment failed')
                }
            }
        })
    }
    $('#addressForm').submit((event) => {
        console.log("form")
        event.preventDefault()
        $.ajax({
            url: '/save-address',
            method: 'post',
            data: $('#addressForm').serialize(),
            success: ((response) => {
                $("#addressContainer").load(location.href + " #addressContainer")
            })
        })
    })

</script>